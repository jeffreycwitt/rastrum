#!/usr/bin/env ruby
require "bundler/setup"
require "rastrum"
require 'open-uri'
require "thor"

module RastrumCLI
	class Release < Thor
		desc "draft", "perform release procedure"
		long_desc <<-LONGDESC
      This command performs a draft release for the contents of this directory. The procedure will run through every
      tei document within the directory, change the edition number to the next edition number specified in the version.xml file. At the same time it will log a new entry into the revision description, and record the most current of the status as "draft."

      After completing the xml file updates, the procedure will commit the repository and tag it (e.g. v0.2.0).

      It will end by pushing the repository to the development respository, specified as git remote origin.

      -i, with -i opition, this procedure will be interactive, prompting the user for confirmation before each change to each file within the directory.

      -q, with the -q option, all notices of what the procedure is doing will be silenced. The default is to be verbose.

      LONGDESC
		def draft
			## Make changes to file
			if Rastrum::Tool.check_version == false
				puts "You've already used this version number, please update the transcriptions file"
			else
				#perform update
				ed_no = Rastrum::Tool.next_version
				Rastrum::Tool.directory_update("draft", ed_no)
				#full git update
				Rastrum::Repo.full_update(ed_no)
				
				#reset version to x.x.x-dev
				Rastrum::Tool.directory_update_dev(ed_no + "-dev")
				#commit changes, without tag
				Rastrum::Repo.light_update(ed_no + "-dev")
			end
		end
		desc "review", "perform release procedure"
		long_desc <<-LONGDESC
      This command performs a review-version release for the contents of this directory. The procedure will run through every tei document within the directory, change the edition number to the next edition number specified in the version.xml file. At the same time it will log a new entry into the revision description, and record the most current of the status as "review-version." 

      After completing the xml file updates, the procedure will commit the repository and tag it (e.g. v0.2.0).

      It will end by pushing the repository to both to the development respository, specified as git remote origin, and the review repository specified as git remote dll

      -i, with -i opition, this procedure will be interactive, prompting the user for confirmation before each change to each file within the directory.

      -q, with the -q option, all notices of what the procedure is doing will be silenced. The default is to be verbose.

      LONGDESC
		def review
			if Rastrum::Tool.check_version == false
				puts "You've already used this version number, please update the transcriptions file"
			else
				ed_no = Rastrum::Tool.next_version
				Rastrum::Tool.directory_update("review", ed_no)
				#full git update
				Rastrum::Repo.full_update(ed_no)
				
				#reset version to x.x.x-dev
				Rastrum::Tool.directory_update_dev(ed_no + "-dev")
				#commit changes, without tag
				Rastrum::Repo.light_update(ed_no + "-dev")

				puts "--after this update a push to dll should occur."
			end
		end
		desc "published", "performs published procedure"
		long_desc <<-LONGDESC
      This command performs a published release for the contents of this directory. The procedure will run through every tei document within the directory, change the edition number to the next edition number specified in the version.xml file. At the same time it will log a new entry into the revision description, and record the most current of the status as "published."

      After completing the xml file updates, the procedure will commit the repository and tag it (e.g. v1.0.0).

      If the current respository only has a master branch, it will create a new branch called "develop" and checkout to this branch where all subsequent development should be done. 

      If release published is called when already on a development branch, the release published command will merge the development branch into the master branch, and the checkout back out to the development branch, changing the status of the devleopment texts back to "draft" and the edition number to x.x.x-dev.

      It will end by pushing the repository to both to the development respository, specified as git remote origin, and the review repository specified as git remote dll

      -i, with -i opition, this procedure will be interactive, prompting the user for confirmation before each change to each file within the directory.

      -q, with the -q option, all notices of what the procedure is doing will be silenced. The default is to be verbose.

      LONGDESC
		def published
			if Rastrum::Tool.check_version == false
				puts "You've already used this version number, please update the transcriptions file"
			else
				ed_no = Rastrum::Tool.next_version
				Rastrum::Tool.directory_update("published", ed_no)
				#full git update
				Rastrum::Repo.full_update(ed_no)
				
				#reset version to x.x.x-dev
				Rastrum::Tool.directory_update_dev(ed_no + "-dev")
				#commit changes, without tag
				Rastrum::Repo.light_update(ed_no + "-dev")
				puts "--after this update a push to dll should occur and develop branch should be created"
			end
		end
	end
	class Hotfix < Thor
		desc "new", "creates new hotfix"
		def new
		puts "creates new hotfix"
		end
		desc "release", "releases hotfix"
		def release
		puts "releases hotfix"
		end
	end
	class Create < Thor
		option :dup
		desc "diplomatic", "create new diplomatic file"
		long_desc <<-LONGDESC
			"rastrum create diplomatic <prefix>" creates a new file from the prefix and repo name

			--dup, the duplicate command allows the user to create a new transcription file from a copy of an existing transcription, usually an existing transcription of another witness, while changing the file name relevant fields in the teiHeader
		LONGDESC
		def diplomatic(prefix)
			puts "creates a new file for diplomatic transcription"
			if options[:dup]
				download = open(options[:dup])
			else
				download = open("https://bitbucket.org/lombardpress/lombardpress-templates/raw/master/template-diplomatic.xml")
			end
			IO.copy_stream(download, prefix + "_" + Rastrum::Tool.dirname + ".xml")
			doc = Rastrum::Document.new(prefix + "_" + Rastrum::Tool.dirname + ".xml")
			doc.set_date
			doc.set_date_orig
			doc.save(Rastrum::Tool.dirname + ".xml")
		end
		option :dup
		desc "critical", "create new critical file"
		long_desc <<-LONGDESC
			"rastrum create diplomatic " creates a new file from the prefix and repo name

			--dup, the duplicate command allows the user to create a new transcription file from a copy of an existing transcription, usually an existing transcription of another witness, while changing the file name relevant fields in the teiHeader
		LONGDESC
		def critical
			puts "creates a new critical file from template"
			if options[:dup]
				download = open(options[:dup])
			else
				download = open("https://bitbucket.org/lombardpress/lombardpress-templates/raw/master/template-critical.xml")
			end
			IO.copy_stream(download, Rastrum::Tool.dirname + ".xml")
			doc = Rastrum::Document.new(Rastrum::Tool.dirname + ".xml")
			doc.set_date
			doc.set_date_orig
			doc.save(Rastrum::Tool.dirname + ".xml")
		end
		
	end

	class Core < Thor
		
		desc "version", "ask for rastrum version"
		def version
		puts Rastrum::VERSION
		end
		desc "new", "create new repository"
		long_desc <<-LONGDESC
			"rastrum new <reponame>" creates a new repository with dummy tei files, specified in the configuration options. Additionally, the new command will create dummy readme file, a Rastrumfile for further customaization, a version.xml file. 

			Finally it initate a git repository and commit a "first commit"
		LONGDESC
		def new(name)
			puts "create new respository called #{name} with starter files"
		end
		
		desc "update", "perform update procedure"
		def update
			puts "creates processed files, commits, and pushes"
		end
		desc "release", "controls release, with version and status updates"
		subcommand "release", Release

		desc "hotfix", "manages hotfix creation and merge"
		subcommand "hotfix", Hotfix

		desc "create", "controls create commands"
		subcommand "create", Create
	end

	
end

RastrumCLI::Core.start(ARGV)